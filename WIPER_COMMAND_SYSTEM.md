# æ™ºèƒ½é›¨åˆ·å‘½ä»¤ç³»ç»Ÿå®Œå–„è¯´æ˜

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®Œå–„äº†æ™ºèƒ½é›¨åˆ·çš„HTTPåŒæ­¥å‘½ä»¤ç³»ç»Ÿï¼Œå®ç°äº†å‰ç«¯ã€æœåŠ¡å™¨ã€è®¾å¤‡ç«¯çš„å®Œæ•´å‘½ä»¤ä¼ é€’é“¾è·¯ï¼Œæä¾›äº†å¯é çš„é›¨åˆ·æ§åˆ¶åŠŸèƒ½ã€‚

## ğŸ¯ ä¸»è¦æ”¹è¿›

### 1. **ç»Ÿä¸€å‘½ä»¤æ ¼å¼**
- **å‰ç«¯å‘½ä»¤**: `off`, `interval`, `low`, `high`, `smart`
- **HTTPåŒæ­¥å‘½ä»¤æ ¼å¼**: 
  ```json
  {
    "wiper_control": "low",
    "timestamp": 1703123456789,
    "source": "http_sync_command",
    "command_id": "wiper_ctrl_1703123456789",
    "user": "admin"
  }
  ```
- **çŠ¶æ€æŸ¥è¯¢æ ¼å¼**:
  ```json
  {
    "wiper_status_query": true,
    "timestamp": 1703123456789,
    "source": "http_sync_command",
    "command_id": "wiper_status_1703123456789",
    "user": "admin"
  }
  ```

### 2. **å¢å¼ºå‰ç«¯ç”¨æˆ·ä½“éªŒ**
- âœ… åŠ è½½çŠ¶æ€æ˜¾ç¤ºï¼šæ§åˆ¶è¿‡ç¨‹ä¸­æ˜¾ç¤º"æ§åˆ¶ä¸­..."
- âœ… æŒ‰é’®ç¦ç”¨ï¼šé˜²æ­¢é‡å¤ç‚¹å‡»
- âœ… å®æ—¶çŠ¶æ€æŒ‡ç¤ºï¼šæ˜¾ç¤ºæ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤
- âœ… é”™è¯¯åˆ†ç±»å¤„ç†ï¼šåŒºåˆ†è®¾å¤‡ç¦»çº¿ã€å‘½ä»¤å¤±è´¥ç­‰ä¸åŒé”™è¯¯
- âœ… è§†è§‰åé¦ˆï¼šåŠ è½½åŠ¨ç”»å’ŒçŠ¶æ€å›¾æ ‡

### 3. **å®Œå–„è®¾å¤‡ç«¯å‘½ä»¤å¤„ç†**
- âœ… å‘½ä»¤æœ‰æ•ˆæ€§éªŒè¯
- âœ… è¯¦ç»†çš„å“åº”æ•°æ®
- âœ… é”™è¯¯å¤„ç†å’Œåé¦ˆ
- âœ… å‘½ä»¤æ‰§è¡Œæ—¥å¿—

### 4. **æ”¹è¿›é”™è¯¯å¤„ç†**
- âœ… è®¾å¤‡ç¦»çº¿æ£€æµ‹
- âœ… å‘½ä»¤æ‰§è¡Œå¤±è´¥åé¦ˆ
- âœ… è¶…æ—¶å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯å¤„ç†

## ğŸ”§ æŠ€æœ¯å®ç°

### å‰ç«¯ (Vue.js)
```javascript
// é›¨åˆ·æ§åˆ¶çŠ¶æ€ç®¡ç†
const isWiperControlLoading = ref(false);
const pendingStatus = ref('');

// å‘½ä»¤æ‰§è¡Œæµç¨‹
const changeStatus = async (status) => {
  isWiperControlLoading.value = true;
  pendingStatus.value = status;
  
  try {
    const result = await wiperService.control(status);
    if (result.success) {
      currentStatus.value = status;
      showWiperControlMessage(`é›¨åˆ·å·²åˆ‡æ¢åˆ°${status}æ¨¡å¼`);
    } else {
      handleError(result);
    }
  } finally {
    isWiperControlLoading.value = false;
    pendingStatus.value = '';
  }
};
```

### æœåŠ¡å™¨ç«¯ (Node.js)
```javascript
// HTTPåŒæ­¥å‘½ä»¤APIç«¯ç‚¹
router.post('/api-control', authMiddleware, async (req, res) => {
  const { command } = req.body;
  const username = req.user?.username;
  
  // éªŒè¯å‘½ä»¤
  const validCommands = ['off', 'interval', 'low', 'high', 'smart'];
  if (!validCommands.includes(command)) {
    return res.status(400).json({
      success: false,
      error: 'æ— æ•ˆçš„é›¨åˆ·å‘½ä»¤'
    });
  }
  
  // è°ƒç”¨Python HTTPæ§åˆ¶è„šæœ¬
  const python = spawn('python', [
    HTTP_CONTROL_SCRIPT, 
    '--action', 'control', 
    '--status', command, 
    '--username', username, 
    '--timeout', '15'
  ]);
  
  // å¤„ç†å“åº”...
});
```

### è®¾å¤‡ç«¯ (Python)
```python
def process_command(cmd_data):
    """å¤„ç†é›¨åˆ·æ§åˆ¶å‘½ä»¤"""
    if "wiper_control" in cmd_data:
        wiper_command = cmd_data["wiper_control"]
        command_id = cmd_data.get("command_id", "unknown")
        user = cmd_data.get("user", "unknown")
        
        # éªŒè¯å‘½ä»¤æœ‰æ•ˆæ€§
        valid_commands = ['off', 'interval', 'low', 'high', 'smart']
        if wiper_command not in valid_commands:
            return {
                "errno": 1,
                "error": f"æ— æ•ˆçš„é›¨åˆ·å‘½ä»¤: {wiper_command}",
                "command_id": command_id
            }
        
        # æ‰§è¡Œå‘½ä»¤
        device_state["wiper_status"] = wiper_command
        
        return {
            "errno": 0,
            "data": {
                "wiper_status": wiper_command,
                "message": f"é›¨åˆ·å·²åˆ‡æ¢åˆ°{wiper_command}æ¨¡å¼",
                "command_id": command_id,
                "user": user
            }
        }
```

## ğŸ¨ ç”¨æˆ·ç•Œé¢æ”¹è¿›

### çŠ¶æ€åˆ—è¡¨
- **è§†è§‰çŠ¶æ€**: å½“å‰æ¿€æ´»çŠ¶æ€é«˜äº®æ˜¾ç¤º
- **åŠ è½½æŒ‡ç¤º**: æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
- **ç¦ç”¨çŠ¶æ€**: æ§åˆ¶è¿‡ç¨‹ä¸­å…¶ä»–é€‰é¡¹å˜ç°ç¦ç”¨

### æ§åˆ¶æŒ‰é’®
- **åŠ¨æ€æ–‡æœ¬**: æ ¹æ®å½“å‰çŠ¶æ€æ˜¾ç¤º"å¼€å¯é›¨åˆ·"æˆ–"ç«‹å³å…³é—­"
- **åŠ è½½çŠ¶æ€**: æ§åˆ¶è¿‡ç¨‹ä¸­æ˜¾ç¤º"æ§åˆ¶ä¸­..."
- **ç¦ç”¨ä¿æŠ¤**: é˜²æ­¢é‡å¤ç‚¹å‡»

### é”™è¯¯åé¦ˆ
- **åˆ†ç±»é”™è¯¯**: åŒºåˆ†è®¾å¤‡ç¦»çº¿ã€å‘½ä»¤å¤±è´¥ã€ç½‘ç»œé”™è¯¯
- **å‹å¥½æç¤º**: ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- **è‡ªåŠ¨æ¸…é™¤**: 5ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯

## ğŸ“Š æ”¯æŒçš„é›¨åˆ·æ¨¡å¼

| æ¨¡å¼ | è‹±æ–‡æ ‡è¯† | ä¸­æ–‡åç§° | åŠŸèƒ½æè¿° |
|------|----------|----------|----------|
| off | `off` | å…³é—­ | åœæ­¢é›¨åˆ·å·¥ä½œ |
| interval | `interval` | é—´æ­‡ | é—´æ­‡æ€§å·¥ä½œæ¨¡å¼ |
| low | `low` | ä½é€Ÿ | ä½é€Ÿè¿ç»­å·¥ä½œ |
| high | `high` | é«˜é€Ÿ | é«˜é€Ÿè¿ç»­å·¥ä½œ |
| smart | `smart` | æ™ºèƒ½ | æ ¹æ®é›¨é‡è‡ªåŠ¨è°ƒèŠ‚ |

## ğŸ” æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•
```bash
# è¿è¡Œé›¨åˆ·å‘½ä»¤æµ‹è¯•
python test_wiper_commands.py
```

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤
1. **å‰ç«¯æµ‹è¯•**: åœ¨ä¸»æ§åˆ¶ç•Œé¢ç‚¹å‡»ä¸åŒçš„é›¨åˆ·æ¨¡å¼
2. **çŠ¶æ€éªŒè¯**: ç¡®è®¤å‰ç«¯çŠ¶æ€ä¸è®¾å¤‡å®é™…çŠ¶æ€ä¸€è‡´
3. **é”™è¯¯æµ‹è¯•**: æµ‹è¯•è®¾å¤‡ç¦»çº¿æ—¶çš„é”™è¯¯å¤„ç†
4. **åŠ è½½æµ‹è¯•**: éªŒè¯åŠ è½½çŠ¶æ€å’Œç¦ç”¨åŠŸèƒ½

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å‰ç«¯éƒ¨ç½²
```bash
# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

### æœåŠ¡å™¨éƒ¨ç½²
```bash
# å¯åŠ¨Node.jsæœåŠ¡å™¨
node server/app.js
```

### è®¾å¤‡æ¨¡æ‹Ÿå™¨
```bash
# å¯åŠ¨è®¾å¤‡æ¨¡æ‹Ÿå™¨
python python/mqtt_device_simulator.py --device-name device3
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **å‘½ä»¤å»é‡**: é˜²æ­¢é‡å¤å‘é€ç›¸åŒå‘½ä»¤
- **è¶…æ—¶æ§åˆ¶**: 15ç§’å‘½ä»¤è¶…æ—¶ï¼Œ10ç§’çŠ¶æ€æŸ¥è¯¢è¶…æ—¶
- **é”™è¯¯é‡è¯•**: è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
- **çŠ¶æ€ç¼“å­˜**: æœ¬åœ°çŠ¶æ€ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚

## ğŸ”’ å®‰å…¨è€ƒè™‘

- **ç”¨æˆ·è®¤è¯**: æ‰€æœ‰å‘½ä»¤éƒ½éœ€è¦ç”¨æˆ·ç™»å½•
- **å‘½ä»¤éªŒè¯**: æœåŠ¡å™¨ç«¯éªŒè¯å‘½ä»¤æœ‰æ•ˆæ€§
- **æƒé™æ§åˆ¶**: åŸºäºç”¨æˆ·çš„è®¾å¤‡è®¿é—®æ§åˆ¶
- **æ—¥å¿—è®°å½•**: å®Œæ•´çš„å‘½ä»¤æ‰§è¡Œæ—¥å¿—

## ğŸ“ åç»­æ”¹è¿›è®¡åˆ’

1. **æ‰¹é‡æ§åˆ¶**: æ”¯æŒåŒæ—¶æ§åˆ¶å¤šä¸ªè®¾å¤‡
2. **å®šæ—¶ä»»åŠ¡**: æ”¯æŒå®šæ—¶é›¨åˆ·æ§åˆ¶
3. **å†å²è®°å½•**: å‘½ä»¤æ‰§è¡Œå†å²æŸ¥è¯¢
4. **æ€§èƒ½ç›‘æ§**: å‘½ä»¤æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡ç»Ÿè®¡
5. **ç§»åŠ¨ç«¯ä¼˜åŒ–**: é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„ç•Œé¢ä¼˜åŒ–
