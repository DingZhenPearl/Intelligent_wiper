# 地图页面定位修复测试指南

## 测试环境
- **平台**: Android 应用
- **网络**: 确保设备有网络连接
- **位置**: 测试时可以在不同位置进行

## 测试步骤

### 1. 基本定位功能测试
1. 打开应用，进入地图页面
2. 观察地图是否正常加载（不应该自动定位）
3. 点击"定位"按钮
4. **预期结果**: 
   - 如果有GPS权限且GPS开启：显示精确位置标记
   - 如果没有GPS权限或GPS关闭：自动回退到IP定位，显示大概位置

### 2. 权限拒绝测试
1. 在设备设置中拒绝应用的位置权限
2. 打开应用，进入地图页面
3. 点击"定位"按钮
4. **预期结果**: 
   - 应该自动使用IP定位
   - 在地图上显示位置标记（精度较低，约10km）
   - 控制台显示IP定位相关日志

### 3. GPS关闭测试
1. 确保应用有位置权限
2. 在设备设置中关闭GPS/位置服务
3. 打开应用，进入地图页面
4. 点击"定位"按钮
5. **预期结果**: 
   - GPS定位失败后自动回退到IP定位
   - 显示位置标记

### 4. 网络环境测试
1. 在不同网络环境下测试（WiFi、移动数据、弱网络）
2. 点击"定位"按钮
3. **预期结果**: 
   - 在有网络的情况下应该能够定位
   - 网络较差时可能需要更长时间

### 5. 重复定位测试
1. 多次点击"定位"按钮
2. **预期结果**: 
   - 每次定位都应该移除之前的位置标记
   - 只显示一个当前位置标记
   - 地图中心应该移动到新的位置

### 6. 与其他页面对比测试
1. 测试天气页面的定位功能
2. 测试导航页面的"获取目前位置"功能
3. **预期结果**: 
   - 所有页面的定位行为应该一致
   - 都应该有GPS→IP定位的备选机制

## 关键日志检查

在浏览器开发者工具或Android Studio的Logcat中查看以下日志：

### 成功定位的日志
```
[地图] 开始定位
[地图服务] 开始获取当前位置
[位置服务] 在原生环境中获取当前位置...
[位置服务] 原生定位成功: {...}
[地图服务] 格式化后的位置信息: {...}
[地图] 定位成功: {...}
[地图] 定位和标记成功
```

### IP定位备选的日志
```
[地图] 开始定位
[地图服务] 开始获取当前位置
[位置服务] GPS定位失败: ...
[位置服务] 尝试使用IP定位作为备选
[位置服务] IP定位成功: {...}
[地图] 定位成功: {...}
```

### 错误情况的日志
```
[地图] 定位失败: Error: ...
```

## 常见问题排查

### 1. 定位完全失败
- 检查网络连接
- 检查IP定位服务是否可用
- 查看控制台错误信息

### 2. 只有IP定位，没有GPS定位
- 检查应用位置权限
- 检查设备GPS是否开启
- 在室外环境测试GPS信号

### 3. 定位精度不高
- GPS定位精度通常在几米到几十米
- IP定位精度通常在几公里到几十公里
- 这是正常现象

## 成功标准
- ✅ 地图页面定位功能正常工作
- ✅ 有GPS权限时使用GPS定位
- ✅ 没有GPS权限时自动回退到IP定位
- ✅ 与其他页面定位行为一致
- ✅ 错误处理友好，有明确的错误提示
- ✅ 重复定位时正确管理位置标记
