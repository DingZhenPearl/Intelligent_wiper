# å‰ç«¯çŠ¶æ€åŒæ­¥æ›´æ–°è¯´æ˜

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¿®æ”¹äº†å‰ç«¯æ§åˆ¶é€»è¾‘ï¼Œä½¿å…¶ä¸åç«¯çš„CMDæ ¼å¼å¯¹åº”ï¼Œå¹¶åœ¨æ¯æ¬¡è¿›å…¥ä¸»é¡µæ—¶è‡ªåŠ¨è·å–å½“å‰é›¨åˆ·çŠ¶æ€ã€‚

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### å‰ç«¯æ–‡ä»¶
1. **`src/services/wiperService.js`**
   - æ·»åŠ äº† `getCurrentStatusViaCMD()` æ–¹æ³•
   - é€šè¿‡CMDå‘½ä»¤è·å–é›¨åˆ·å½“å‰çŠ¶æ€

2. **`src/views/Home/index.vue`**
   - æ·»åŠ äº† `fetchCurrentWiperStatus()` å‡½æ•°
   - åœ¨ `onMounted` ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨çŠ¶æ€è·å–
   - ä¼˜å…ˆä½¿ç”¨CMDæ–¹å¼ï¼Œå¤±è´¥æ—¶å›é€€åˆ°æ™®é€šAPI

### åç«¯æ–‡ä»¶
3. **`server/wiper-control.js`**
   - æ·»åŠ äº† `/api/wiper/get-status-cmd` ç«¯ç‚¹
   - æ”¯æŒé€šè¿‡CMDå‘½ä»¤è·å–é›¨åˆ·çŠ¶æ€

4. **`python/onenet_mqtt_control.py`**
   - æ·»åŠ äº† `send_cmd_get_status_command()` å‡½æ•°
   - æ·»åŠ äº† `get-status` æ“ä½œæ”¯æŒ
   - å‘é€CMDæ ¼å¼çš„çŠ¶æ€æŸ¥è¯¢å‘½ä»¤

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨çŠ¶æ€åŒæ­¥
- **è¿›å…¥ä¸»é¡µæ—¶è‡ªåŠ¨è·å–çŠ¶æ€**ï¼šæ¯æ¬¡ç”¨æˆ·è¿›å…¥ä¸»é¡µæ—¶ï¼Œå‰ç«¯ä¼šè‡ªåŠ¨å‘é€CMDå‘½ä»¤è·å–å½“å‰é›¨åˆ·çŠ¶æ€
- **åŒé‡ä¿éšœæœºåˆ¶**ï¼šä¼˜å…ˆä½¿ç”¨CMDæ–¹å¼ï¼Œå¦‚æœå¤±è´¥åˆ™å›é€€åˆ°æ™®é€šAPIæ–¹å¼
- **çŠ¶æ€æ˜¾ç¤ºåŒæ­¥**ï¼šç¡®ä¿å‰ç«¯æ˜¾ç¤ºçš„çŠ¶æ€ä¸åç«¯å®é™…çŠ¶æ€ä¸€è‡´

### 2. CMDå‘½ä»¤æ ¼å¼
- **çŠ¶æ€æŸ¥è¯¢å‘½ä»¤**ï¼š
  ```json
  {
    "get_status": true,
    "timestamp": 1703123456789
  }
  ```
- **MQTTä¸»é¢˜**ï¼š`$sys/{PRODUCT_ID}/{device_name}/cmd/request/{cmdid}`
- **å›å¤ä¸»é¢˜**ï¼š`$sys/{PRODUCT_ID}/{device_name}/cmd/response/{cmdid}`

### 3. APIç«¯ç‚¹
- **æ–°å¢ç«¯ç‚¹**ï¼š`POST /api/wiper/get-status-cmd`
- **è¯·æ±‚ä½“**ï¼š`{}` (ç©ºå¯¹è±¡)
- **å“åº”æ ¼å¼**ï¼š
  ```json
  {
    "success": true,
    "message": "CMDè·å–çŠ¶æ€å‘½ä»¤å‘é€æˆåŠŸï¼Œç­‰å¾…è®¾å¤‡å›å¤",
    "status": "unknown",
    "device_name": "device_name",
    "method": "MQTT_CMD",
    "cmdid": 1703123456789,
    "topic": "$sys/product_id/device_name/cmd/request/1703123456789",
    "note": "çŠ¶æ€æŸ¥è¯¢å‘½ä»¤å·²å‘é€åˆ°OneNETå¹³å°ï¼Œç­‰å¾…çœŸå®è®¾å¤‡å›å¤å½“å‰çŠ¶æ€"
  }
  ```

## ğŸ”„ å·¥ä½œæµç¨‹

### å‰ç«¯çŠ¶æ€è·å–æµç¨‹
1. **ç”¨æˆ·è¿›å…¥ä¸»é¡µ**
2. **è°ƒç”¨ `fetchCurrentWiperStatus()`**
3. **å°è¯•CMDæ–¹å¼è·å–çŠ¶æ€**
   - è°ƒç”¨ `wiperService.getCurrentStatusViaCMD()`
   - å‘é€è¯·æ±‚åˆ° `/api/wiper/get-status-cmd`
4. **å¦‚æœCMDæ–¹å¼å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šAPI**
   - è°ƒç”¨ `wiperService.getStatus()`
   - å‘é€è¯·æ±‚åˆ° `/api/wiper/status`
5. **æ›´æ–°å‰ç«¯çŠ¶æ€æ˜¾ç¤º**

### åç«¯å¤„ç†æµç¨‹
1. **æ¥æ”¶å‰ç«¯è¯·æ±‚**
2. **è°ƒç”¨Pythonè„šæœ¬**ï¼š`python onenet_mqtt_control.py --action get-status --username {username}`
3. **Pythonè„šæœ¬æ‰§è¡Œ**ï¼š
   - è¿æ¥MQTTæœåŠ¡å™¨
   - å‘é€CMDæ ¼å¼çš„çŠ¶æ€æŸ¥è¯¢å‘½ä»¤
   - ç­‰å¾…è®¾å¤‡å›å¤ï¼ˆå®é™…åœºæ™¯ä¸­ï¼‰
   - è¿”å›ç»“æœ
4. **è¿”å›å“åº”ç»™å‰ç«¯**

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. çŠ¶æ€ä¸€è‡´æ€§
- å‰ç«¯æ˜¾ç¤ºçš„é›¨åˆ·çŠ¶æ€å§‹ç»ˆä¸åç«¯å®é™…çŠ¶æ€ä¿æŒä¸€è‡´
- é¿å…äº†å‰ç«¯çŠ¶æ€ä¸è®¾å¤‡å®é™…çŠ¶æ€ä¸åŒæ­¥çš„é—®é¢˜

### 2. å®æ—¶æ€§
- æ¯æ¬¡è¿›å…¥ä¸»é¡µéƒ½ä¼šè·å–æœ€æ–°çŠ¶æ€
- ç¡®ä¿ç”¨æˆ·çœ‹åˆ°çš„æ˜¯å½“å‰çœŸå®çŠ¶æ€

### 3. å¯é æ€§
- åŒé‡ä¿éšœæœºåˆ¶ç¡®ä¿çŠ¶æ€è·å–çš„å¯é æ€§
- å³ä½¿CMDæ–¹å¼å¤±è´¥ï¼Œä¹Ÿèƒ½é€šè¿‡æ™®é€šAPIè·å–çŠ¶æ€

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å‰ç«¯å®ç°
```javascript
// è·å–å½“å‰é›¨åˆ·çŠ¶æ€
const fetchCurrentWiperStatus = async () => {
  try {
    // é¦–å…ˆå°è¯•é€šè¿‡CMDå‘½ä»¤è·å–çŠ¶æ€
    const cmdResult = await wiperService.getCurrentStatusViaCMD();
    
    if (cmdResult.success && cmdResult.status) {
      currentStatus.value = cmdResult.status;
      return;
    }
    
    // å¦‚æœCMDæ–¹å¼å¤±è´¥ï¼Œå°è¯•æ™®é€šAPIæ–¹å¼
    const apiResult = await wiperService.getStatus();
    
    if (apiResult.success && apiResult.status) {
      currentStatus.value = apiResult.status;
    } else {
      currentStatus.value = 'off'; // é»˜è®¤çŠ¶æ€
    }
  } catch (error) {
    currentStatus.value = 'off'; // é»˜è®¤çŠ¶æ€
  }
};
```

### åç«¯å®ç°
```python
def send_cmd_get_status_command():
    """å‘é€CMDæ ¼å¼çš„è·å–çŠ¶æ€å‘½ä»¤åˆ°OneNETå¹³å°"""
    # æ„å»ºCMDæ ¼å¼çš„è·å–çŠ¶æ€å‘½ä»¤
    cmd_data = {
        "get_status": True,
        "timestamp": cmdid
    }
    
    # å‘é€åˆ°OneNETå¹³å°
    result = mqtt_client.publish(command_topic, payload, qos=1)
    
    return {
        "success": True,
        "message": "CMDè·å–çŠ¶æ€å‘½ä»¤å‘é€æˆåŠŸï¼Œç­‰å¾…è®¾å¤‡å›å¤",
        "status": "unknown",  # çŠ¶æ€éœ€è¦ä»è®¾å¤‡å›å¤ä¸­è·å–
        "device_name": current_device_name,
        "method": "MQTT_CMD",
        "cmdid": cmdid,
        "topic": command_topic,
        "note": "çŠ¶æ€æŸ¥è¯¢å‘½ä»¤å·²å‘é€åˆ°OneNETå¹³å°ï¼Œç­‰å¾…çœŸå®è®¾å¤‡å›å¤å½“å‰çŠ¶æ€"
    }
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. å‰ç«¯éƒ¨ç½²
- æ— éœ€é¢å¤–é…ç½®
- ä¿®æ”¹ä¼šåœ¨ä¸‹æ¬¡é¡µé¢åˆ·æ–°æ—¶ç”Ÿæ•ˆ

### 2. åç«¯éƒ¨ç½²
- é‡å¯Node.jsæœåŠ¡å™¨ä»¥åŠ è½½æ–°çš„APIç«¯ç‚¹
- Pythonè„šæœ¬æ”¯æŒæ–°çš„ `get-status` æ“ä½œ

### 3. æµ‹è¯•éªŒè¯
- è¿›å…¥ä¸»é¡µï¼Œæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
- éªŒè¯é›¨åˆ·çŠ¶æ€æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®
- æµ‹è¯•CMDå‘½ä»¤æ˜¯å¦æ­£å¸¸å‘é€

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è®¾å¤‡å›å¤**ï¼šå½“å‰å®ç°ä¸­ï¼ŒçŠ¶æ€æŸ¥è¯¢å‘½ä»¤ä¼šå‘é€åˆ°OneNETå¹³å°ï¼Œä½†å®é™…çŠ¶æ€éœ€è¦çœŸå®è®¾å¤‡å›å¤
2. **è¶…æ—¶å¤„ç†**ï¼šå¦‚æœè®¾å¤‡é•¿æ—¶é—´ä¸å›å¤ï¼Œå‰ç«¯ä¼šä½¿ç”¨é»˜è®¤çŠ¶æ€
3. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰é”™è¯¯æƒ…å†µéƒ½æœ‰ç›¸åº”çš„å¤„ç†å’Œæ—¥å¿—è®°å½•
4. **å…¼å®¹æ€§**ï¼šä¿æŒäº†ä¸ç°æœ‰åŠŸèƒ½çš„å®Œå…¨å…¼å®¹æ€§

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **çŠ¶æ€ç¼“å­˜**ï¼šå¯ä»¥è€ƒè™‘åœ¨å‰ç«¯ç¼“å­˜çŠ¶æ€ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯·æ±‚
2. **å®æ—¶ç›‘å¬**ï¼šå¯ä»¥è€ƒè™‘é€šè¿‡WebSocketç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–
3. **è¶…æ—¶é…ç½®**ï¼šå¯ä»¥æ·»åŠ å¯é…ç½®çš„è¶…æ—¶æ—¶é—´
4. **é‡è¯•æœºåˆ¶**ï¼šå¯ä»¥æ·»åŠ è‡ªåŠ¨é‡è¯•æœºåˆ¶
