# 使用 HTTPS 运行智能雨刷系统

本文档提供了如何使用 HTTPS 运行智能雨刷系统的说明。

## 为什么使用 HTTPS？

使用 HTTPS 有以下好处：

1. **安全性**：HTTPS 加密传输的数据，防止中间人攻击和数据窃取。
2. **地理位置 API**：现代浏览器要求地理位置 API 只能在安全上下文（HTTPS）中使用。
3. **其他敏感 API**：许多现代浏览器 API（如摄像头、麦克风等）也要求 HTTPS。

## 快速启动（推荐）

我们提供了一个简单的启动脚本，它会自动检查 SSL 证书，并在需要时生成证书：

```bash
node start-server.js
```

按照提示操作即可。脚本会询问您是否要生成 SSL 证书（如果不存在），以及是否要强制使用 HTTPS。

## 手动设置

如果您想手动设置 HTTPS，请按照以下步骤操作：

### 1. 生成 SSL 证书

运行以下命令生成自签名 SSL 证书：

```bash
node server/generate-cert-crypto.js
```

这将在 `server/ssl` 目录中创建以下文件：
- `key.pem`：私钥
- `cert.pem`：证书

### 2. 启动服务器

启动服务器时，可以选择是否强制使用 HTTPS：

```bash
# 不强制使用 HTTPS（同时提供 HTTP 和 HTTPS）
node server/server.js

# 强制使用 HTTPS（HTTP 请求会被重定向到 HTTPS）
FORCE_HTTPS=true node server/server.js
```

## 端口

服务器使用以下端口：

- HTTP：3000（默认）
- HTTPS：3001（HTTP 端口 + 1）

您可以在 `server/config.js` 中修改 HTTP 端口。

## 处理浏览器安全警告

由于我们使用的是自签名证书，浏览器会显示安全警告。这是正常的，您可以：

1. 点击"高级"或"详细信息"
2. 点击"继续访问"或"接受风险并继续"

在开发环境中，这是可以接受的。在生产环境中，您应该使用由受信任的证书颁发机构颁发的证书。

## 在移动设备上使用

当您在移动设备上访问服务器时，请确保：

1. 使用服务器启动时显示的 IP 地址
2. 使用正确的端口（HTTP: 3000, HTTPS: 3001）
3. 如果使用 HTTPS，请在浏览器中接受安全警告

## 故障排除

### 证书生成失败

如果证书生成失败，请确保：

1. 已安装 OpenSSL 并添加到系统 PATH 中
2. 有足够的权限创建和写入文件

### 无法访问 HTTPS 服务器

如果无法访问 HTTPS 服务器，请检查：

1. 防火墙是否允许 3001 端口的流量
2. 是否正确接受了浏览器的安全警告
3. 服务器日志中是否有错误信息

### 地理位置 API 仍然不工作

如果地理位置 API 仍然不工作，请确保：

1. 使用的是 HTTPS URL（`https://...`）
2. 浏览器已授予地理位置权限
3. 没有其他浏览器扩展或设置阻止地理位置 API
